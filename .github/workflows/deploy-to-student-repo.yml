name: Deploy to Student Repository

on:
    push:
        branches: ['practical-*'] # Trigger on practical branches only (after PR merge)
    workflow_dispatch: # Allow manual triggering
    # Note: This workflow should NOT trigger on pull_request events
    # Tests are handled separately by test-practical.yml

env:
    # Configure the target student repository based on current branch/practical
    STUDENT_REPO_NAME: auto # Change this for different practicals

# Optimize permissions for better security
permissions:
    contents: read
    actions: read

jobs:
    # First job: Run tests using the reusable test workflow
    test:
        uses: ./.github/workflows/test-practical.yml

    # Second job: Deploy only if tests pass
    deploy:
        needs: test # Wait for test job to complete successfully
        runs-on: ubuntu-latest
        timeout-minutes: 10 # Prevent runaway jobs

        steps:
            - name: Checkout source repository
              uses: actions/checkout@v5
              with:
                  fetch-depth: 1 # Shallow clone for better performance
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js with caching
              uses: actions/setup-node@v4
              with:
                  node-version: '20' # Use LTS version
                  cache: 'npm'
                  cache-dependency-path: '**/package*.json'

            - name: Cache workflow dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache
                      /tmp/workflow-cache
                  key: deploy-cache-${{ runner.os }}-${{ github.sha }}
                  restore-keys: |
                      deploy-cache-${{ runner.os }}-

            - name: Determine target repository
              id: repo-config
              run: |
                  # Auto-detect repository name from branch or use environment variable
                  BRANCH_NAME=${GITHUB_REF#refs/heads/}

                  # Extract practical number from branch name (e.g., practical-1, practical-2)
                  if [[ $BRANCH_NAME =~ practical-([0-9]+) ]]; then
                    REPO_NAME="practical-${BASH_REMATCH[1]}"
                  else
                    # Fallback: use branch name directly
                    REPO_NAME="$BRANCH_NAME"
                  fi

                  echo "TARGET_REPO=$REPO_NAME" >> $GITHUB_OUTPUT
                  echo "::notice::Deploying to repository: SP-DIT/$REPO_NAME"

            - name: Tests passed - Proceeding with deployment
              run: |
                  BRANCH_NAME=${GITHUB_REF#refs/heads/}
                  PRACTICAL_NUMBER=$(echo "$BRANCH_NAME" | grep -o '[0-9]\+')
                  echo "::notice::âœ… Tests passed for practical $PRACTICAL_NUMBER - Starting deployment process"

            - name: Generate GitHub App Token
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ vars.APP_ID }}
                  private-key: ${{ secrets.APP_PRIVATE_KEY }}
                  owner: SP-DIT
                  repositories: ${{ github.event.repository.name }},${{ steps.repo-config.outputs.TARGET_REPO }}

            - name: Process files for student version
              run: |
                  set -euo pipefail # Better error handling

                  # Create processing summary
                  echo "::group::File Processing"

                  # Remove solution files efficiently
                  find . -name "solution.js" -type f -delete
                  echo "âœ“ Removed solution.js files"

                  # Remove instructor-only files in batch
                  find . \( -name "*.instructor.*" -o -name "instructor-*" \) -type f -delete
                  echo "âœ“ Removed instructor-only files"

                  # Replace settings.json with student version (disable Copilot)
                  if [ -f "instructor/student-settings.json" ]; then
                    cp instructor/student-settings.json .vscode/settings.json
                    echo "âœ“ Replaced settings.json with student version"
                  fi

                  # Clean up instructor directories efficiently
                  rm -rf instructor/ instructor-notes/ solutions/ .github/workflows/deploy-to-student-repo.yml 2>/dev/null || true
                  echo "âœ“ Cleaned up instructor directories"

                  echo "::endgroup::"

            - name: Clone student repository
              uses: actions/checkout@v5
              with:
                  repository: SP-DIT/${{ steps.repo-config.outputs.TARGET_REPO }}
                  token: ${{ steps.app-token.outputs.token }}
                  path: student-repo
                  fetch-depth: 1 # Shallow clone for performance

            - name: Deploy to student repository
              run: |
                  set -euo pipefail

                  echo "::group::Repository Deployment with Commit Squashing"
                  cd student-repo

                  # Configure Git with enhanced settings
                  git config user.name 'github-actions[bot]'
                  git config user.email '41898282+github-actions[bot]@users.noreply.github.com'

                  # Create a fresh orphan branch (no history)
                  git checkout --orphan temp-main

                  # Remove any existing content
                  git rm -rf . 2>/dev/null || true

                  # Copy processed files with better error handling
                  cd ..
                  find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'student-repo' -exec cp -r {} student-repo/ \; 2>/dev/null || true
                  cd student-repo

                  # Stage all new content
                  git add .

                  if git diff --staged --quiet; then
                    echo "::notice::No changes to deploy"
                  else
                    # Get the practical number for commit message
                    BRANCH_NAME=${GITHUB_REF#refs/heads/}
                    PRACTICAL_NUMBER=$(echo "$BRANCH_NAME" | grep -o '[0-9]\+')
                    
                    # Create a single squashed commit with clean message
                    git commit -m "ðŸŽ“ Practical content deployment - SP-DIT/ST0523-FOP-practicals (practical-${PRACTICAL_NUMBER}) - $(date '+%Y-%m-%d %H:%M:%S UTC') - Clean deployment with squashed commits"

                    # Delete the old main branch and rename temp-main to main
                    git branch -D main 2>/dev/null || true
                    git branch -m temp-main main

                    # Force push the new clean history
                    git push --force origin main
                    echo "::notice::âœ… Successfully deployed with squashed commits (clean history)"
                  fi

                  echo "::endgroup::"

            - name: Deployment Summary
              run: |
                  TARGET_REPO="${{ steps.repo-config.outputs.TARGET_REPO }}"
                  echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… **Status:** Clean deployment with squashed commits completed!" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“š **Target:** [SP-DIT/${TARGET_REPO}](https://github.com/SP-DIT/${TARGET_REPO})" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ”„ **Strategy:** Squashed all commits into single clean commit" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ§¹ **Processing:** Files cleaned and optimized for student distribution" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“œ **History:** No instructor development history preserved" >> $GITHUB_STEP_SUMMARY
                  echo "â° **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
