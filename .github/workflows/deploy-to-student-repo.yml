name: Deploy to Student Repository

on:
    push:
        branches: ['practical-*'] # Trigger on practical branches only
    workflow_dispatch: # Allow manual triggering

env:
    # Configure the target student repository based on current branch/practical
    STUDENT_REPO_NAME: auto # Change this for different practicals

# Optimize permissions for better security
permissions:
    contents: read
    actions: read

jobs:
    deploy-student-version:
        runs-on: ubuntu-latest
        timeout-minutes: 10 # Prevent runaway jobs

        steps:
            - name: Checkout source repository
              uses: actions/checkout@v5
              with:
                  fetch-depth: 1 # Shallow clone for better performance
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js with caching
              uses: actions/setup-node@v4
              with:
                  node-version: '20' # Use LTS version
                  cache: 'npm'
                  cache-dependency-path: '**/package*.json'

            - name: Cache workflow dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache
                      /tmp/workflow-cache
                  key: deploy-cache-${{ runner.os }}-${{ github.sha }}
                  restore-keys: |
                      deploy-cache-${{ runner.os }}-

            - name: Determine target repository
              id: repo-config
              run: |
                  # Auto-detect repository name from branch or use environment variable
                  BRANCH_NAME=${GITHUB_REF#refs/heads/}

                  # Extract practical number from branch name (e.g., practical-1, practical-2)
                  if [[ $BRANCH_NAME =~ practical-([0-9]+) ]]; then
                    REPO_NAME="practical-${BASH_REMATCH[1]}"
                  else
                    # Fallback: use branch name directly
                    REPO_NAME="$BRANCH_NAME"
                  fi

                  echo "TARGET_REPO=$REPO_NAME" >> $GITHUB_OUTPUT
                  echo "::notice::Deploying to repository: SP-DIT/$REPO_NAME"

            - name: Generate GitHub App Token
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ vars.APP_ID }}
                  private-key: ${{ secrets.APP_PRIVATE_KEY }}
                  owner: SP-DIT
                  repositories: ${{ github.event.repository.name }},${{ steps.repo-config.outputs.TARGET_REPO }}

            - name: Process files for student version
              run: |
                  set -euo pipefail # Better error handling

                  # Create processing summary
                  echo "::group::File Processing"

                  # Remove solution files efficiently
                  find . -name "solution.js" -type f -delete
                  echo "âœ“ Removed solution.js files"

                  # Remove instructor-only files in batch
                  find . \( -name "*.instructor.*" -o -name "instructor-*" \) -type f -delete
                  echo "âœ“ Removed instructor-only files"

                  # Replace settings.json with student version (disable Copilot)
                  if [ -f "instructor/student-settings.json" ]; then
                    cp instructor/student-settings.json .vscode/settings.json
                    echo "âœ“ Replaced settings.json with student version"
                  fi

                  # Clean up instructor directories efficiently
                  rm -rf instructor/ instructor-notes/ solutions/ .github/workflows/deploy-to-student-repo.yml 2>/dev/null || true
                  echo "âœ“ Cleaned up instructor directories"

                  echo "::endgroup::"

            - name: Clone student repository
              uses: actions/checkout@v5
              with:
                  repository: SP-DIT/${{ steps.repo-config.outputs.TARGET_REPO }}
                  token: ${{ steps.app-token.outputs.token }}
                  path: student-repo
                  fetch-depth: 1 # Shallow clone for performance

            - name: Deploy to student repository
              run: |
                  set -euo pipefail
                  
                  echo "::group::Repository Deployment"
                  cd student-repo

                  # Configure Git with enhanced settings
                  git config user.name 'github-actions[bot]'
                  git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
                  
                  # Create or switch to main branch
                  git checkout main 2>/dev/null || git checkout -b main

                  # Efficient content replacement
                  find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

                  # Copy processed files with better error handling
                  cd ..
                  find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'student-repo' -exec cp -r {} student-repo/ \; 2>/dev/null || true
                  cd student-repo

                  # Stage and commit with conditional logic
                  git add .

                  if git diff --staged --quiet; then
                    echo "::notice::No changes to deploy"
                  else
                    COMMIT_MSG="ðŸš€ Auto-deploy from instructor repository ($(date '+%Y-%m-%d %H:%M:%S'))"
                    git commit -m "$COMMIT_MSG"
                    # Force push to overwrite student repository completely
                    git push --force origin main
                    echo "::notice::âœ… Successfully force-pushed to student repository (clean deployment)"
                  fi
                  
                  echo "::endgroup::"            - name: Deployment Summary
              run: |
                  TARGET_REPO="${{ steps.repo-config.outputs.TARGET_REPO }}"
                  echo "## ðŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… **Status:** Clean deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“š **Target:** [SP-DIT/${TARGET_REPO}](https://github.com/SP-DIT/${TARGET_REPO})" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ”„ **Strategy:** Force push for clean student repository (no history preservation)" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ§¹ **Processing:** Files cleaned and optimized for student distribution" >> $GITHUB_STEP_SUMMARY
                  echo "â° **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
