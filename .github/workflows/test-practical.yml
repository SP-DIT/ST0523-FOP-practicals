name: Test Practical Solutions

on:
    pull_request:
        branches: ['practical-*'] # Test PRs to practical branches (primary use case)
    workflow_call: # Allow this workflow to be called by deploy workflow
    workflow_dispatch: # Allow manual triggering

# Optimize permissions for better security
permissions:
    contents: read
    actions: read

jobs:
    test-practical:
        runs-on: ubuntu-latest
        timeout-minutes: 5 # Quick testing timeout

        steps:
            - name: Checkout repository
              uses: actions/checkout@v5
              with:
                  fetch-depth: 1 # Shallow clone for better performance

            - name: Setup Node.js with caching
              uses: actions/setup-node@v4
              with:
                  node-version: '20' # Use LTS version
                  cache: 'npm'
                  cache-dependency-path: '**/package*.json'

            - name: Run tests to validate practical solutions
              run: |
                  echo "::group::Running Tests"
                  
                  # Extract practical number from branch name or PR context
                  if [[ "$GITHUB_REF" == refs/pull/* ]]; then
                    # For PR context, use the head ref (source branch)
                    BRANCH_NAME="${GITHUB_HEAD_REF}"
                    echo "PR context detected - using head ref: $BRANCH_NAME"
                  else
                    # For push context, use the ref
                    BRANCH_NAME=${GITHUB_REF#refs/heads/}
                    echo "Push context detected - using branch: $BRANCH_NAME"
                  fi
                  
                  echo "Current branch: $BRANCH_NAME"
                  
                  # Extract the number from practical-X or wip/practical-X
                  PRACTICAL_NUMBER=$(echo "$BRANCH_NAME" | grep -o '[0-9]\+')
                  TEST_COMMAND="p${PRACTICAL_NUMBER}"
                  
                  echo "::notice::Detected practical number: $PRACTICAL_NUMBER"
                  echo "::notice::Running test command: node run $TEST_COMMAND"
                  
                  # Set NODE_ENV to test to use solution.js files
                  export NODE_ENV=test
                  
                  # Run the test for the detected practical
                  if node run "$TEST_COMMAND"; then
                    echo "::notice::âœ… All tests passed for practical $PRACTICAL_NUMBER!"
                    echo "::notice::ðŸš€ Ready for merge to practical-$PRACTICAL_NUMBER branch"
                  else
                    echo "::error::âŒ Tests failed for practical $PRACTICAL_NUMBER!"
                    echo "::error::ðŸ”§ Please fix the issues before merging"
                    exit 1
                  fi
                  
                  echo "::endgroup::"

            - name: Test Summary
              if: always()
              run: |
                  if [[ "$GITHUB_REF" == refs/pull/* ]]; then
                    BRANCH_NAME="${GITHUB_HEAD_REF}"
                  else
                    BRANCH_NAME=${GITHUB_REF#refs/heads/}
                  fi
                  PRACTICAL_NUMBER=$(echo "$BRANCH_NAME" | grep -o '[0-9]\+')
                  
                  echo "## ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Practical:** $PRACTICAL_NUMBER" >> $GITHUB_STEP_SUMMARY
                  echo "**Purpose:** Continuous testing during development" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ job.status }}" == "success" ]; then
                    echo "âœ… **Status:** All tests passed! Ready for merge." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **Status:** Tests failed. Please review and fix." >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "â° **Time:** $(date)" >> $GITHUB_STEP_SUMMARY